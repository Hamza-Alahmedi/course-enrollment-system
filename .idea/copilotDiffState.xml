<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/course-enrollment-backend/src/main/java/com/hamza/courseenrollmentsystem/config/CustomAuthenticationProvider.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/course-enrollment-backend/src/main/java/com/hamza/courseenrollmentsystem/config/CustomAuthenticationProvider.java" />
              <option name="originalContent" value="package com.hamza.courseenrollmentsystem.config;&#10;&#10;import com.hamza.courseenrollmentsystem.entity.User;&#10;import com.hamza.courseenrollmentsystem.repository.UserRepository;&#10;import com.hamza.courseenrollmentsystem.service.UserService;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.security.authentication.AuthenticationProvider;&#10;import org.springframework.security.authentication.BadCredentialsException;&#10;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;&#10;import org.springframework.security.core.Authentication;&#10;import org.springframework.security.core.AuthenticationException;&#10;import org.springframework.security.core.authority.SimpleGrantedAuthority;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.stereotype.Component;&#10;&#10;import java.util.Collections;&#10;import java.util.Optional;&#10;&#10;@Component&#10;public class CustomAuthenticationProvider implements AuthenticationProvider {&#10;&#10;    @Autowired&#10;    private UserRepository userRepository;&#10;&#10;    @Autowired&#10;    private UserService userService;&#10;&#10;    @Autowired&#10;    private PasswordEncoder passwordEncoder;&#10;&#10;    @Override&#10;    public Authentication authenticate(Authentication authentication) throws AuthenticationException {&#10;        String email = authentication.getName();&#10;        String password = authentication.getCredentials().toString();&#10;&#10;        Optional&lt;User&gt; userOptional = userRepository.findByEmail(email);&#10;&#10;        if (userOptional.isEmpty()) {&#10;            throw new BadCredentialsException(&quot;User not found&quot;);&#10;        }&#10;&#10;        User user = userOptional.get();&#10;&#10;        // Check password (handles both plain text and BCrypt)&#10;        if (userService.checkPassword(password, user.getPassword())) {&#10;            // Upgrade password if it's plain text&#10;            userService.upgradePasswordToBCrypt(user, password);&#10;&#10;            return new UsernamePasswordAuthenticationToken(&#10;                    email,&#10;                    password,&#10;                    Collections.singletonList(new SimpleGrantedAuthority(&quot;ROLE_&quot; + user.getRole()))&#10;            );&#10;        } else {&#10;            throw new BadCredentialsException(&quot;Invalid password&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public boolean supports(Class&lt;?&gt; authentication) {&#10;        return UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication);&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.hamza.courseenrollmentsystem.config;&#10;&#10;import com.hamza.courseenrollmentsystem.entity.User;&#10;import com.hamza.courseenrollmentsystem.repository.UserRepository;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.security.authentication.AuthenticationProvider;&#10;import org.springframework.security.authentication.BadCredentialsException;&#10;import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;&#10;import org.springframework.security.core.Authentication;&#10;import org.springframework.security.core.AuthenticationException;&#10;import org.springframework.security.core.authority.SimpleGrantedAuthority;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.stereotype.Component;&#10;&#10;import java.util.Collections;&#10;import java.util.Optional;&#10;&#10;@Component&#10;public class CustomAuthenticationProvider implements AuthenticationProvider {&#10;&#10;    @Autowired&#10;    private UserRepository userRepository;&#10;&#10;    @Autowired&#10;    private PasswordEncoder passwordEncoder;&#10;&#10;    @Override&#10;    public Authentication authenticate(Authentication authentication) throws AuthenticationException {&#10;        String email = authentication.getName();&#10;        String password = authentication.getCredentials().toString();&#10;&#10;        Optional&lt;User&gt; userOptional = userRepository.findByEmail(email);&#10;&#10;        if (userOptional.isEmpty()) {&#10;            throw new BadCredentialsException(&quot;User not found&quot;);&#10;        }&#10;&#10;        User user = userOptional.get();&#10;&#10;        // Check password (handles both plain text and BCrypt)&#10;        boolean passwordMatches;&#10;        if (user.getPassword().startsWith(&quot;$2a$&quot;) || user.getPassword().startsWith(&quot;$2b$&quot;)) {&#10;            // BCrypt password&#10;            passwordMatches = passwordEncoder.matches(password, user.getPassword());&#10;        } else {&#10;            // Plain text password&#10;            passwordMatches = password.equals(user.getPassword());&#10;            &#10;            // Upgrade to BCrypt if plain text&#10;            if (passwordMatches) {&#10;                user.setPassword(passwordEncoder.encode(password));&#10;                userRepository.save(user);&#10;                System.out.println(&quot;âœ… Upgraded password to BCrypt for user: &quot; + user.getEmail());&#10;            }&#10;        }&#10;&#10;        if (passwordMatches) {&#10;            return new UsernamePasswordAuthenticationToken(&#10;                    email,&#10;                    password,&#10;                    Collections.singletonList(new SimpleGrantedAuthority(&quot;ROLE_&quot; + user.getRole()))&#10;            );&#10;        } else {&#10;            throw new BadCredentialsException(&quot;Invalid password&quot;);&#10;        }&#10;    }&#10;&#10;    @Override&#10;    public boolean supports(Class&lt;?&gt; authentication) {&#10;        return UsernamePasswordAuthenticationToken.class.isAssignableFrom(authentication);&#10;    }&#10;}&#10;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>