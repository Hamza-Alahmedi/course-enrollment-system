<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/course-enrollment-backend/src/main/java/com/hamza/courseenrollmentsystem/config/SecurityConfig.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/course-enrollment-backend/src/main/java/com/hamza/courseenrollmentsystem/config/SecurityConfig.java" />
              <option name="originalContent" value="package com.hamza.courseenrollmentsystem.config;&#10;&#10;import com.hamza.courseenrollmentsystem.entity.User;&#10;import com.hamza.courseenrollmentsystem.repository.UserRepository;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.beans.factory.annotation.Value;&#10;import org.springframework.context.annotation.Bean;&#10;import org.springframework.context.annotation.Configuration;&#10;import org.springframework.security.config.annotation.web.builders.HttpSecurity;&#10;import org.springframework.security.core.authority.SimpleGrantedAuthority;&#10;import org.springframework.security.core.userdetails.UserDetailsService;&#10;import org.springframework.security.core.userdetails.UsernameNotFoundException;&#10;import org.springframework.security.crypto.password.NoOpPasswordEncoder;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.security.web.SecurityFilterChain;&#10;import org.springframework.web.cors.CorsConfigurationSource;&#10;&#10;import java.util.Collections;&#10;&#10;@Configuration&#10;public class SecurityConfig {&#10;&#10;    @Autowired&#10;    private UserRepository userRepository;&#10;&#10;    @Autowired&#10;    private CustomAuthenticationSuccessHandler successHandler;&#10;&#10;    @Autowired&#10;    private CorsConfigurationSource corsConfigurationSource;&#10;&#10;    @Value(&quot;${frontend.url:https://course-enrollment-frontend-c9mr.onrender.com}&quot;)&#10;    private String frontendUrl;&#10;&#10;    @Bean&#10;    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {&#10;        http&#10;                .cors(cors -&gt; cors.configurationSource(corsConfigurationSource))&#10;                .csrf(csrf -&gt; csrf.disable())  // Disabled for development&#10;                .authorizeHttpRequests(auth -&gt; auth&#10;                        // Admin routes - require ADMIN role&#10;                        .requestMatchers(&quot;/admin/**&quot;).hasRole(&quot;ADMIN&quot;)&#10;                        // Student routes - require STUDENT role&#10;                        .requestMatchers(&quot;/student/**&quot;).hasRole(&quot;STUDENT&quot;)&#10;                        // Public routes&#10;                        .requestMatchers(&quot;/&quot;, &quot;/login&quot;, &quot;/register&quot;, &quot;/api/**&quot;, &quot;/css/**&quot;, &quot;/js/**&quot;).permitAll()&#10;                        // All other routes are open for development&#10;                        .anyRequest().permitAll()&#10;                )&#10;                .formLogin(form -&gt; form&#10;                        .loginPage(&quot;/login&quot;)&#10;                        .usernameParameter(&quot;email&quot;)  // Use email instead of username&#10;                        .successHandler(successHandler)  // Use custom success handler for role-based redirect&#10;                        .failureUrl(&quot;/login?error&quot;)&#10;                        .permitAll()&#10;                )&#10;                .logout(logout -&gt; logout&#10;                        .logoutUrl(&quot;/logout&quot;)&#10;                        .logoutSuccessUrl(frontendUrl)&#10;                        .invalidateHttpSession(true)&#10;                        .deleteCookies(&quot;JSESSIONID&quot;)&#10;                        .permitAll()&#10;                );&#10;&#10;        return http.build();&#10;    }&#10;&#10;    @Bean&#10;    @SuppressWarnings(&quot;deprecation&quot;)&#10;    public PasswordEncoder passwordEncoder() {&#10;        return NoOpPasswordEncoder.getInstance();&#10;    }&#10;&#10;    @Bean&#10;    public UserDetailsService userDetailsService() {&#10;        return email -&gt; {&#10;            User user = userRepository.findByEmail(email)&#10;                    .orElseThrow(() -&gt; new UsernameNotFoundException(&quot;User not found: &quot; + email));&#10;&#10;            return new org.springframework.security.core.userdetails.User(&#10;                    user.getEmail(),&#10;                    user.getPassword(),&#10;                    Collections.singletonList(new SimpleGrantedAuthority(&quot;ROLE_&quot; + user.getRole()))&#10;            );&#10;        };&#10;    }&#10;&#10;}&#10;" />
              <option name="updatedContent" value="package com.hamza.courseenrollmentsystem.config;&#10;&#10;import com.hamza.courseenrollmentsystem.entity.User;&#10;import com.hamza.courseenrollmentsystem.repository.UserRepository;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.beans.factory.annotation.Value;&#10;import org.springframework.context.annotation.Bean;&#10;import org.springframework.context.annotation.Configuration;&#10;import org.springframework.security.config.annotation.web.builders.HttpSecurity;&#10;import org.springframework.security.core.authority.SimpleGrantedAuthority;&#10;import org.springframework.security.core.userdetails.UserDetailsService;&#10;import org.springframework.security.core.userdetails.UsernameNotFoundException;&#10;import org.springframework.security.crypto.password.NoOpPasswordEncoder;&#10;import org.springframework.security.crypto.password.PasswordEncoder;&#10;import org.springframework.security.web.SecurityFilterChain;&#10;import org.springframework.web.cors.CorsConfigurationSource;&#10;&#10;import java.util.Collections;&#10;&#10;@Configuration&#10;public class SecurityConfig {&#10;&#10;    @Autowired&#10;    private UserRepository userRepository;&#10;&#10;    @Autowired&#10;    private CustomAuthenticationSuccessHandler successHandler;&#10;&#10;    @Autowired&#10;    private CorsConfigurationSource corsConfigurationSource;&#10;&#10;    @Value(&quot;${frontend.url:https://course-enrollment-frontend-c9mr.onrender.com}&quot;)&#10;    private String frontendUrl;&#10;&#10;    @Bean&#10;    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {&#10;        http&#10;                .cors(cors -&gt; cors.configurationSource(corsConfigurationSource))&#10;                .csrf(csrf -&gt; csrf.disable())  // Disabled for development&#10;                .authorizeHttpRequests(auth -&gt; auth&#10;                        // Admin routes - require ADMIN role&#10;                        .requestMatchers(&quot;/admin/**&quot;).hasRole(&quot;ADMIN&quot;)&#10;                        // Student routes - require STUDENT role&#10;                        .requestMatchers(&quot;/student/**&quot;).hasRole(&quot;STUDENT&quot;)&#10;                        // Public routes&#10;                        .requestMatchers(&quot;/&quot;, &quot;/login&quot;, &quot;/register&quot;, &quot;/api/**&quot;, &quot;/css/**&quot;, &quot;/js/**&quot;).permitAll()&#10;                        // All other routes are open for development&#10;                        .anyRequest().permitAll()&#10;                )&#10;                .sessionManagement(session -&gt; session&#10;                        .sessionFixation().migrateSession()&#10;                        .maximumSessions(5)&#10;                        .maxSessionsPreventsLogin(false)&#10;                )&#10;                .formLogin(form -&gt; form&#10;                        .loginPage(&quot;/login&quot;)&#10;                        .usernameParameter(&quot;email&quot;)  // Use email instead of username&#10;                        .successHandler(successHandler)  // Use custom success handler for role-based redirect&#10;                        .failureUrl(&quot;/login?error&quot;)&#10;                        .permitAll()&#10;                )&#10;                .logout(logout -&gt; logout&#10;                        .logoutUrl(&quot;/logout&quot;)&#10;                        .logoutSuccessUrl(frontendUrl)&#10;                        .invalidateHttpSession(true)&#10;                        .deleteCookies(&quot;JSESSIONID&quot;)&#10;                        .permitAll()&#10;                );&#10;&#10;        return http.build();&#10;    }&#10;&#10;    @Bean&#10;    @SuppressWarnings(&quot;deprecation&quot;)&#10;    public PasswordEncoder passwordEncoder() {&#10;        return NoOpPasswordEncoder.getInstance();&#10;    }&#10;&#10;    @Bean&#10;    public UserDetailsService userDetailsService() {&#10;        return email -&gt; {&#10;            User user = userRepository.findByEmail(email)&#10;                    .orElseThrow(() -&gt; new UsernameNotFoundException(&quot;User not found: &quot; + email));&#10;&#10;            return new org.springframework.security.core.userdetails.User(&#10;                    user.getEmail(),&#10;                    user.getPassword(),&#10;                    Collections.singletonList(new SimpleGrantedAuthority(&quot;ROLE_&quot; + user.getRole()))&#10;            );&#10;        };&#10;    }&#10;&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/course-enrollment-backend/src/main/java/com/hamza/courseenrollmentsystem/controller/api/RatingApiController.java">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/course-enrollment-backend/src/main/java/com/hamza/courseenrollmentsystem/controller/api/RatingApiController.java" />
              <option name="originalContent" value="package com.hamza.courseenrollmentsystem.controller.api;&#10;&#10;import com.hamza.courseenrollmentsystem.dto.AverageRatingDto;&#10;import com.hamza.courseenrollmentsystem.dto.RatingDto;&#10;import com.hamza.courseenrollmentsystem.service.RatingService;&#10;import org.springframework.beans.factory.annotation.Autowired;&#10;import org.springframework.http.HttpStatus;&#10;import org.springframework.http.ResponseEntity;&#10;import org.springframework.security.core.Authentication;&#10;import org.springframework.web.bind.annotation.*;&#10;&#10;@RestController&#10;@RequestMapping(&quot;/api/courses&quot;)&#10;@CrossOrigin(&#10;    originPatterns = &quot;*&quot;,&#10;    allowCredentials = &quot;true&quot;,&#10;    methods = {RequestMethod.GET, RequestMethod.POST, RequestMethod.PUT, RequestMethod.DELETE, RequestMethod.OPTIONS}&#10;)&#10;public class RatingApiController {&#10;&#10;    @Autowired&#10;    private RatingService ratingService;&#10;&#10;    /**&#10;     * GET /api/courses/{id}/rating/avg&#10;     * Get average rating for a course&#10;     */&#10;    @GetMapping(&quot;/{id}/rating/avg&quot;)&#10;    public ResponseEntity&lt;AverageRatingDto&gt; getAverageRating(@PathVariable Long id) {&#10;        try {&#10;            AverageRatingDto result = ratingService.getAverageRating(id);&#10;            return ResponseEntity.ok(result);&#10;        } catch (Exception e) {&#10;            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)&#10;                    .body(new AverageRatingDto(null, &quot;Error: &quot; + e.getMessage()));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * GET /api/courses/{id}/rating/me&#10;     * Get current user's rating for a course&#10;     */&#10;    @GetMapping(&quot;/{id}/rating/me&quot;)&#10;    public ResponseEntity&lt;RatingDto&gt; getUserRating(@PathVariable Long id, Authentication authentication) {&#10;        try {&#10;            if (authentication == null || authentication.getName() == null) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();&#10;            }&#10;&#10;            String userEmail = authentication.getName();&#10;            RatingDto result = ratingService.getUserRating(id, userEmail);&#10;            return ResponseEntity.ok(result);&#10;        } catch (Exception e) {&#10;            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)&#10;                    .body(new RatingDto(null));&#10;        }&#10;    }&#10;&#10;    /**&#10;     * POST /api/courses/{id}/rating&#10;     * Save or update user's rating for a course&#10;     */&#10;    @PostMapping(&quot;/{id}/rating&quot;)&#10;    public ResponseEntity&lt;?&gt; saveRating(&#10;            @PathVariable Long id,&#10;            @RequestBody RatingDto ratingDto,&#10;            Authentication authentication) {&#10;        try {&#10;            if (authentication == null || authentication.getName() == null) {&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)&#10;                        .body(&quot;User not authenticated&quot;);&#10;            }&#10;&#10;            if (ratingDto.getRating() == null) {&#10;                return ResponseEntity.badRequest().body(&quot;Rating is required&quot;);&#10;            }&#10;&#10;            String userEmail = authentication.getName();&#10;            RatingDto result = ratingService.saveRating(id, userEmail, ratingDto.getRating());&#10;            return ResponseEntity.ok(result);&#10;        } catch (IllegalArgumentException e) {&#10;            return ResponseEntity.badRequest().body(e.getMessage());&#10;        } catch (RuntimeException e) {&#10;            return ResponseEntity.status(HttpStatus.FORBIDDEN).body(e.getMessage());&#10;        } catch (Exception e) {&#10;            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)&#10;                    .body(&quot;Error saving rating: &quot; + e.getMessage());&#10;        }&#10;    }&#10;}&#10;&#10;" />
              <option name="updatedContent" value="package com.hamza.courseenrollmentsystem.controller.api;&#13;&#10;&#13;&#10;import com.hamza.courseenrollmentsystem.dto.AverageRatingDto;&#13;&#10;import com.hamza.courseenrollmentsystem.dto.RatingDto;&#13;&#10;import com.hamza.courseenrollmentsystem.service.RatingService;&#13;&#10;import org.springframework.beans.factory.annotation.Autowired;&#13;&#10;import org.springframework.http.HttpStatus;&#13;&#10;import org.springframework.http.ResponseEntity;&#13;&#10;import org.springframework.security.core.Authentication;&#13;&#10;import org.springframework.web.bind.annotation.*;&#13;&#10;&#13;&#10;@RestController&#10;@RequestMapping(&quot;/api/courses&quot;)&#10;@CrossOrigin(&#10;    origins = &quot;https://course-enrollment-frontend-c9mr.onrender.com&quot;,&#10;    allowCredentials = &quot;true&quot;,&#10;    allowedHeaders = &quot;*&quot;,&#10;    methods = {RequestMethod.GET, RequestMethod.POST, RequestMethod.PUT, RequestMethod.DELETE, RequestMethod.OPTIONS}&#10;)&#10;public class RatingApiController {&#13;&#10;&#13;&#10;    @Autowired&#13;&#10;    private RatingService ratingService;&#13;&#10;&#13;&#10;    /**&#13;&#10;     * GET /api/courses/{id}/rating/avg&#13;&#10;     * Get average rating for a course&#13;&#10;     */&#13;&#10;    @GetMapping(&quot;/{id}/rating/avg&quot;)&#13;&#10;    public ResponseEntity&lt;AverageRatingDto&gt; getAverageRating(@PathVariable Long id) {&#13;&#10;        try {&#13;&#10;            AverageRatingDto result = ratingService.getAverageRating(id);&#13;&#10;            return ResponseEntity.ok(result);&#13;&#10;        } catch (Exception e) {&#13;&#10;            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)&#13;&#10;                    .body(new AverageRatingDto(null, &quot;Error: &quot; + e.getMessage()));&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * GET /api/courses/{id}/rating/me&#13;&#10;     * Get current user's rating for a course&#13;&#10;     */&#13;&#10;    @GetMapping(&quot;/{id}/rating/me&quot;)&#13;&#10;    public ResponseEntity&lt;RatingDto&gt; getUserRating(@PathVariable Long id, Authentication authentication) {&#13;&#10;        try {&#13;&#10;            if (authentication == null || authentication.getName() == null) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();&#13;&#10;            }&#13;&#10;&#13;&#10;            String userEmail = authentication.getName();&#13;&#10;            RatingDto result = ratingService.getUserRating(id, userEmail);&#13;&#10;            return ResponseEntity.ok(result);&#13;&#10;        } catch (Exception e) {&#13;&#10;            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)&#13;&#10;                    .body(new RatingDto(null));&#13;&#10;        }&#13;&#10;    }&#13;&#10;&#13;&#10;    /**&#13;&#10;     * POST /api/courses/{id}/rating&#13;&#10;     * Save or update user's rating for a course&#13;&#10;     */&#13;&#10;    @PostMapping(&quot;/{id}/rating&quot;)&#13;&#10;    public ResponseEntity&lt;?&gt; saveRating(&#13;&#10;            @PathVariable Long id,&#13;&#10;            @RequestBody RatingDto ratingDto,&#13;&#10;            Authentication authentication) {&#13;&#10;        try {&#13;&#10;            if (authentication == null || authentication.getName() == null) {&#13;&#10;                return ResponseEntity.status(HttpStatus.UNAUTHORIZED)&#13;&#10;                        .body(&quot;User not authenticated&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            if (ratingDto.getRating() == null) {&#13;&#10;                return ResponseEntity.badRequest().body(&quot;Rating is required&quot;);&#13;&#10;            }&#13;&#10;&#13;&#10;            String userEmail = authentication.getName();&#13;&#10;            RatingDto result = ratingService.saveRating(id, userEmail, ratingDto.getRating());&#13;&#10;            return ResponseEntity.ok(result);&#13;&#10;        } catch (IllegalArgumentException e) {&#13;&#10;            return ResponseEntity.badRequest().body(e.getMessage());&#13;&#10;        } catch (RuntimeException e) {&#13;&#10;            return ResponseEntity.status(HttpStatus.FORBIDDEN).body(e.getMessage());&#13;&#10;        } catch (Exception e) {&#13;&#10;            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)&#13;&#10;                    .body(&quot;Error saving rating: &quot; + e.getMessage());&#13;&#10;        }&#13;&#10;    }&#13;&#10;}&#13;&#10;&#13;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/course-enrollment-backend/src/main/resources/application.properties">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/course-enrollment-backend/src/main/resources/application.properties" />
              <option name="originalContent" value="# Database Configuration - Uses environment variables or defaults to local&#10;spring.datasource.url=${DATABASE_URL:jdbc:mysql://localhost:3306/online_course_db}&#10;spring.datasource.username=${DB_USERNAME:course_user}&#10;spring.datasource.password=${DB_PASSWORD:Test123!#}&#10;spring.jpa.hibernate.ddl-auto=update&#10;spring.jpa.show-sql=true&#10;spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect&#10;&#10;# Server Configuration&#10;server.port=${PORT:8080}&#10;&#10;# Thymeleaf Configuration&#10;spring.thymeleaf.prefix=classpath:/templates/&#10;spring.thymeleaf.suffix=.html&#10;spring.thymeleaf.cache=false&#10;spring.thymeleaf.enabled=true&#10;&#10;spring.security.user.name=user&#10;spring.security.user.password=123&#10;&#10;# CORS Configuration - Allow frontend from Render&#10;allowed.origins=${ALLOWED_ORIGINS:https://course-enrollment-frontend-c9mr.onrender.com}&#10;&#10;# Frontend URL - For redirects after login&#10;frontend.url=${FRONTEND_URL:https://course-enrollment-frontend-c9mr.onrender.com}&#10;&#10;" />
              <option name="updatedContent" value="# Database Configuration - Uses environment variables or defaults to local&#10;spring.datasource.url=${DATABASE_URL:jdbc:mysql://localhost:3306/online_course_db}&#10;spring.datasource.username=${DB_USERNAME:course_user}&#10;spring.datasource.password=${DB_PASSWORD:Test123!#}&#10;spring.jpa.hibernate.ddl-auto=update&#10;spring.jpa.show-sql=true&#10;spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQL8Dialect&#10;&#10;# Server Configuration&#10;server.port=${PORT:8080}&#10;&#10;# Thymeleaf Configuration&#10;spring.thymeleaf.prefix=classpath:/templates/&#10;spring.thymeleaf.suffix=.html&#10;spring.thymeleaf.cache=false&#10;spring.thymeleaf.enabled=true&#10;&#10;spring.security.user.name=user&#10;spring.security.user.password=123&#10;&#10;# CORS Configuration - Allow frontend from Render&#10;allowed.origins=${ALLOWED_ORIGINS:https://course-enrollment-frontend-c9mr.onrender.com}&#10;&#10;# Frontend URL - For redirects after login&#10;frontend.url=${FRONTEND_URL:https://course-enrollment-frontend-c9mr.onrender.com}&#10;&#10;# Session Configuration - Required for cross-site HTTPS cookies&#10;server.servlet.session.cookie.same-site=none&#10;server.servlet.session.cookie.secure=true&#10;server.servlet.session.cookie.http-only=true&#10;server.servlet.session.cookie.max-age=3600&#10;server.servlet.session.timeout=30m&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>